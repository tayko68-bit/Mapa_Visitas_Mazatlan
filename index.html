<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Mapa Vendedores - Flechas</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html, body {height:100%; margin:0;}
#map { height:100vh; }

#leyenda {
  position:absolute;
  bottom:10px; right:10px;
  background:white;
  padding:10px;
  border-radius:6px;
  font-family:sans-serif;
  font-size:13px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  max-height:40vh;
  overflow-y:auto;
  min-width:140px;
  z-index:1000; /* siempre encima */
}
#leyenda h3{margin:0 0 5px 0;font-size:14px;}
#leyenda ul{list-style:none;padding:0;margin:0;}
#leyenda li{margin:3px 0;cursor:pointer;}

.buscador {
  position:absolute; top:10px; right:10px;
  background:white; padding:8px; border-radius:6px;
  font-family:sans-serif; font-size:13px;
  box-shadow:0 2px 6px rgba(0,0,0,0.25);
  display:flex; gap:6px; align-items:center;
  z-index:1000;
}
.buscador input { width:150px; padding:6px; }
.buscador button { padding:6px 8px; cursor:pointer; }
</style>
</head>
<body>
<div id="map"></div>
<div id="leyenda"><h3>Vendedores</h3><ul id="listaVendedores"></ul></div>
<div class="buscador">
  <input id="buscadorVendedor" placeholder="Buscar vendedor..."/>
  <button id="filtrarVendedor">Filtrar</button>
  <button id="limpiarFiltro">Limpiar</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXTg3eVA6lC3oGm3z6P5px1356YcDS0BWv7impbzpNpBJXBlzqgpNkz5nlcKNS2y859diJCY93tqzD/pub?output=csv";

let map = L.map('map').setView([23.25, -106.42], 13); // Mazatl√°n
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(map);

let layerVendedores = L.layerGroup().addTo(map);
let vendedoresColores = {};
let colorPool = ['violet','green','orange','red','blue','brown','darkcyan','gold','magenta','darkgreen','darkorange','darkred'];

function flechaIcon(color){
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
    <polygon points="12,2 15,9 12,7 9,9" fill="${color}" stroke="#333" stroke-width="1"/>
    <line x1="12" y1="7" x2="12" y2="22" stroke="${color}" stroke-width="3"/>
  </svg>`;
  return L.divIcon({
    html:`<div style="width:24px;height:24px;">${svg}</div>`,
    className:'',
    iconSize:[24,24],
    iconAnchor:[12,22]
  });
}

let marcadoresVendedores = [];
function cargarVendedores(){
  Papa.parse(urlCSV,{download:true, header:true, complete:function(results){
    layerVendedores.clearLayers();
    marcadoresVendedores=[];
    let vendedoresUnicos = new Set();
    results.data.forEach(f=>{
      if(!f["COORDENADAS"] || !f["NOMBRE VENDEDOR"]) return;
      const vendedor=f["NOMBRE VENDEDOR"].trim();
      vendedoresUnicos.add(vendedor);
      if(!vendedoresColores[vendedor]){
        if(vendedor.toLowerCase()=="wendy") vendedoresColores[vendedor]="violet";
        else if(vendedor.toLowerCase()=="alfredo") vendedoresColores[vendedor]="green";
        else vendedoresColores[vendedor]=colorPool.shift()||"blue";
      }
      const [lat,lng]=f["COORDENADAS"].split(",").map(Number);
      const m=L.marker([lat,lng],{icon:flechaIcon(vendedoresColores[vendedor])})
        .bindPopup(`<b>${vendedor}</b><br>${f["NOMBRE CLIENTE"]||""}<br>${f["GIRO"]||""}`);
      m.addTo(layerVendedores);
      marcadoresVendedores.push(m);
    });
    construirLeyenda(vendedoresUnicos);
  }});
}

function construirLeyenda(vendedoresUnicos){
  const lista=document.getElementById("listaVendedores");
  lista.innerHTML="";
  vendedoresUnicos.forEach(v=>{
    const li=document.createElement("li");
    li.innerHTML=`<span style="display:inline-block;width:12px;height:12px;background:${vendedoresColores[v]};margin-right:5px;"></span> ${v}`;
    li.onclick=()=>centrarVendedor(v);
    lista.appendChild(li);
  });
}

function centrarVendedor(nombre){
  const puntos=[];
  marcadoresVendedores.forEach(m=>{
    if(m.getPopup().getContent().includes(nombre)) puntos.push(m.getLatLng());
  });
  if(puntos.length>0) map.fitBounds(L.latLngBounds(puntos));
}

// Filtrado
document.getElementById("filtrarVendedor").onclick=()=>{
  const val=document.getElementById("buscadorVendedor").value.toLowerCase().trim();
  marcadoresVendedores.forEach(m=>{
    const cont=m.getPopup().getContent().toLowerCase();
    if(cont.includes(val)) map.addLayer(m);
    else map.removeLayer(m);
  });
};
document.getElementById("limpiarFiltro").onclick=()=>{
  marcadoresVendedores.forEach(m=>map.addLayer(m));
  document.getElementById("buscadorVendedor").value="";
};

cargarVendedores();
setInterval(cargarVendedores,60000);
</script>
</body>
</html>
