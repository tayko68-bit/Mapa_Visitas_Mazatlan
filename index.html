<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa: Vendedores + Prospectos (DENUE)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin:0; padding:0; }
    #map { height: 100vh; }

    /* Panel superior derecho */
    .panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-family: sans-serif;
      z-index: 1000;
      width: 220px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .panel-header {
      padding: 6px 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-content {
      padding: 8px 10px;
    }

    .panel.collapsed {
      max-height: 40px; /* solo cabecera */
    }

    .panel.expanded {
      max-height: 400px;
    }

    .panel select, .panel button {
      width: 14vw;          /* proporcional */
      max-width: 280px;     /* l√≠mite superior */
      min-width: 200px;     /* l√≠mite inferior */
      margin-top:6px;
      padding:6px;
      box-sizing: border-box;
      font-size: 14px;
    }

    /* Leyenda inferior derecha */
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 1000;
      max-height: 40vh;
      overflow-y: auto;
      min-width:150px;
    }
    .legend-item { display:flex; align-items:center; margin-bottom:6px; }
    .legend-color {
      width:16px; height:16px; margin-right:8px; border-radius:50%; border:1px solid #00000040;
      flex:0 0 16px;
    }
    .legend-star {
      width:18px; height:18px; margin-right:8px; display:inline-block; flex:0 0 18px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- üîç Panel plegable -->
  <div class="panel collapsed" id="panel">
    <div class="panel-header" id="panelToggle">
      üîç Buscar prospectos <span id="arrow">‚ñ∂</span>
    </div>
    <div class="panel-content">
      <label for="giroSelect"><strong>Giro</strong></label>
      <select id="giroSelect">
        <option value="">-- Selecciona un giro --</option>
      </select>
      <button id="buscarBtn">Buscar</button>
      <button id="limpiarBtn">Limpiar</button>
      <div id="status" style="margin-top:6px; font-size:12px; color:#333;"></div>
    </div>
  </div>

  <!-- üìç Leyenda -->
  <div class="legend" id="legend"></div>

  <!-- Leaflet + PapaParse -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // üåç Inicializar mapa
    const map = L.map('map').setView([24.799, -107.389], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // üé® Colores para vendedores
    const vendedoresColores = {};
    const coloresDisponibles = [
      "#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231",
      "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe",
      "#008080", "#e6beff", "#9a6324", "#fffac8", "#800000",
      "#aaffc3", "#808000", "#ffd8b1", "#000075", "#808080"
    ];
    let colorIndex = 0;

    // üéØ Construir leyenda unificada
    function construirLeyenda(prospectosActivos = false) {
      const legendDiv = document.getElementById("legend");
      legendDiv.innerHTML = "";

      // --- Vendedores ---
      const tituloVend = document.createElement("div");
      tituloVend.innerHTML = "<strong>Vendedores</strong>";
      legendDiv.appendChild(tituloVend);

      Object.entries(vendedoresColores).forEach(([nombre, color]) => {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
          <div class="legend-color" style="background:${color};"></div>
          <span>${nombre}</span>
        `;
        legendDiv.appendChild(item);
      });

      // --- Prospectos ---
      if (prospectosActivos) {
        const tituloPros = document.createElement("div");
        tituloPros.style.marginTop = "8px";
        tituloPros.innerHTML = "<strong>Prospectos</strong>";
        legendDiv.appendChild(tituloPros);

        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
          <svg class="legend-star" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="gold">
            <path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.783 1.401 8.173L12 18.897l-7.335 3.86 1.401-8.173-5.934-5.783 
                     8.2-1.192z"/>
          </svg>
          <span>Prospecto</span>
        `;
        legendDiv.appendChild(item);
      }
    }

    // üìä URL de Google Sheet (CSV publicado)
    const urlSheet = "TU_URL_DEL_CSV_AQUI";

    // --- Cargar vendedores desde Google Sheet ---
    Papa.parse(urlSheet, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;

        // Detectar vendedores √∫nicos
        data.forEach(row => {
          const vendedor = row["Vendedor"]; // üëà Ajusta al nombre exacto de tu columna
          if (vendedor && !vendedoresColores[vendedor]) {
            vendedoresColores[vendedor] = coloresDisponibles[colorIndex % coloresDisponibles.length];
            colorIndex++;
          }
        });

        // Construir la leyenda inicial
        construirLeyenda(false);

        // üëâ Aqu√≠ sigue tu l√≥gica de pintar marcadores de vendedores en el mapa
      }
    });

    // --- Prospectos (activar/limpiar) ---
    function mostrarProspectos() {
      // üëâ Tu l√≥gica de pintar prospectos
      construirLeyenda(true);
    }
    function limpiarProspectos() {
      // üëâ Tu l√≥gica de limpiar prospectos
      construirLeyenda(false);
    }

    // üìå Panel plegable
    const panel = document.getElementById('panel');
    const toggle = document.getElementById('panelToggle');
    const arrow = document.getElementById('arrow');

    toggle.addEventListener('click', () => {
      if (panel.classList.contains('collapsed')) {
        panel.classList.remove('collapsed');
        panel.classList.add('expanded');
        arrow.textContent = "‚ñº";
      } else {
        panel.classList.remove('expanded');
        panel.classList.add('collapsed');
        arrow.textContent = "‚ñ∂";
      }
    });

    // Botones
    document.getElementById("buscarBtn").addEventListener("click", mostrarProspectos);
    document.getElementById("limpiarBtn").addEventListener("click", limpiarProspectos);
  </script>
</body>
</html>
