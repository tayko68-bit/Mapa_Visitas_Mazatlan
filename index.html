<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa: Vendedores + Prospectos (DENUE)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin:0; padding:0; }
    #map { height: 100vh; }

    .panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-family: sans-serif;
      z-index: 1000;
      min-width: 210px;
    }
    .panel select, .panel button {
      width: 100%;
      margin-top:6px;
      padding:6px;
      box-sizing: border-box;
    }

    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 1000;
      max-height: 40vh;
      overflow-y: auto;
      min-width:150px;
    }
    .legend-item { display:flex; align-items:center; margin-bottom:6px; }
    .legend-color {
      width:16px; height:16px; margin-right:8px; border-radius:50%; border:1px solid #00000040;
      flex:0 0 16px;
    }
    .legend-star {
      width:18px; height:18px; margin-right:8px; display:inline-block; flex:0 0 18px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel" id="panel">
    <label for="giroSelect"><strong>Giro (prospectos)</strong></label>
    <select id="giroSelect">
      <option value="">-- Selecciona un giro --</option>
    </select>
    <button id="buscarBtn">Buscar (en municipio detectado)</button>
    <button id="limpiarBtn">Limpiar prospectos</button>
    <div id="status" style="margin-top:6px; font-size:12px; color:#333;"></div>
  </div>

  <div class="legend" id="legend"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  // ====================== CONFIGURACIÓN ======================
  const URL_VENDEDORES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXTg3eVA6lC3oGm3z6P5px1356YcDS0BWv7impbzpNpBJXBlzqgpNkz5nlcKNS2y859diJCY93tqzD/pub?output=csv";
  const URL_DENUE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTkeTAOHAWUeU8swD3EPEkgvrLzMRawaD0J2l1VQn-IXSpGye4Yz4TzJr59d-xNU_-r7IMFZBgI0IAj/pub?output=csv";

  const GIROS = {
    "Ferreterías": [467111, 467112, 467113],
    "Automotriz y refacciones": [468211, 468212, 811191, 811192],
    "Eléctricas e instalaciones": [238221, 467121],
    "Aluminio y metalmecánica": [238322, 332322, 332710, 332991],
    "Rotulación y construcción ligera": [323111, 238390],
    "Agrícolas y maquinaria": [333111, 333112, 811310, 461110, 461120],
    "Talleres mecánicos": [811191, 811192],
    "Refacciones automotrices": [468211, 468212],
    "Alumineros / carp. aluminio": [332322],
    "Instaladores de rótulos": [323111],
    "Suministros industriales": [332991, 332710]
  };

  // ====================== UTILIDADES ======================
  function normalizarTexto(txt) {
    if (!txt && txt !== 0) return "";
    return String(txt)
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .toLowerCase()
      .trim();
  }

  function crearIconoEstrella() {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <polygon points="12,2 15,9 22,9 17,14 19,22 12,18 5,22 7,14 2,9 9,9"
        fill="#FFD700" stroke="#E6B800" stroke-width="0.7"/>
    </svg>`;
    return L.divIcon({ html: `<div style="width:22px;height:22px;">${svg}</div>`, className:'', iconSize:[22,22], iconAnchor:[11,22], popupAnchor:[0,-18] });
  }

  function crearIconoColor(colorName) {
    return L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${colorName}.png`,
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }

  function valorFila(row, keys) {
    for (const k of keys) if (row[k] !== undefined) return row[k];
    return "";
  }

  // ====================== MAPA ======================
  const map = L.map('map').setView([23.2329, -106.4062], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  const layerVendedores = L.layerGroup().addTo(map);
  const layerProspectos = L.layerGroup().addTo(map);

  let municipioDetectadoNorm = "";
  let denueData = [];
  let vendedoresData = [];
  const vendorColorMap = {};
  let giroSeleccionado = "";

  // ====================== LLENAR SELECT GIROS ======================
  const giroSelect = document.getElementById('giroSelect');
  Object.keys(GIROS).forEach(nombre => {
    const opt = document.createElement('option');
    opt.value = nombre;
    opt.textContent = nombre;
    giroSelect.appendChild(opt);
  });

  giroSelect.addEventListener('change', () => {
    giroSeleccionado = giroSelect.value;
    layerProspectos.clearLayers();
    actualizarProspectosEnMapa();
  });

  // ====================== CARGA VENDEDORES ======================
  function cargarVendedores() {
    Papa.parse(URL_VENDEDORES_CSV, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete(results) {
        vendedoresData = results.data;
        renderVendedores(results.data);
      },
      error(err) {
        console.error("Error cargando vendedores:", err);
        document.getElementById('status').textContent = "Error cargando vendedores";
      }
    });
  }

  function renderVendedores(rows) {
    layerVendedores.clearLayers();
    let colorIndex = 0;
    const palette = ["red","orange","yellow","blue","grey","black","green","violet","pink","cadetblue"];

    rows.forEach(r => {
      const nombreV = valorFila(r, ["NOMBRE VENDEDOR","nombre vendedor","NOMBRE_VENDEDOR","nom_vendedor"]) || "Sin vendedor";
      const coordStr = valorFila(r, ["COORDENADAS","coordenadas","Coordenadas"]) || "";
      let lat=null, lon=null;
      if (coordStr && coordStr.includes(",")) {
        const p = coordStr.split(",").map(s=>s.trim()); lat=parseFloat(p[0]); lon=parseFloat(p[1]);
      } else {
        lat=parseFloat(valorFila(r, ["latitud","LATITUD","Latitud"]));
        lon=parseFloat(valorFila(r, ["longitud","LONGITUD","Longitud"]));
      }
      if (isNaN(lat) || isNaN(lon)) return;
      let colorName = vendorColorMap[nombreV];
      if (!colorName) { colorName = palette[colorIndex % palette
