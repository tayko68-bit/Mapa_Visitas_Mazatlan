<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa: Vendedores + Prospectos (DENUE)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin:0; padding:0; }
    #map { height: 100vh; }

    /* Panel superior derecho (plegable) */
    .panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-family: sans-serif;
      z-index: 1000;
      width: 240px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .panel-header {
      padding: 6px 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-content {
      padding: 8px 10px;
    }

    .panel.collapsed {
      max-height: 36px; /* solo la cabecera visible */
    }

    .panel.expanded {
      max-height: 400px; /* suficiente para mostrar todo */
    }

    .panel select, .panel button {
      width: 14vw;          /* proporcional al ancho */
      max-width: 280px;     /* no crecer m√°s de ~7cm */
      min-width: 200px;     /* no bajar demasiado */
      margin-top:6px;
      padding:6px;
      box-sizing: border-box;
      font-size: 14px;
    }

    /* Leyenda inferior derecha */
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 1000;
      max-height: 40vh;
      overflow-y: auto;
      min-width:150px;
    }
    .legend-item { display:flex; align-items:center; margin-bottom:6px; }
    .legend-color {
      width:16px; height:16px; margin-right:8px; border-radius:50%; border:1px solid #00000040;
      flex:0 0 16px;
    }
    .legend-star {
      width:18px; height:18px; margin-right:8px; display:inline-block; flex:0 0 18px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panel plegable -->
  <div class="panel" id="panel">
    <div class="panel-header" id="panelToggle">
      üîç Buscar prospectos <span id="arrow">‚ñ∂</span>
    </div>
    <div class="panel-content">
      <label for="giroSelect"><strong>Giro</strong></label>
      <select id="giroSelect">
        <option value="">-- Selecciona un giro --</option>
      </select>
      <button id="buscarBtn">Buscar</button>
      <button id="limpiarBtn">Limpiar</button>
      <div id="status" style="margin-top:6px; font-size:12px; color:#333;"></div>
    </div>
  </div>

  <div class="legend" id="legend"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  /************************ CONFIG ************************/
  const URL_VENDEDORES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXTg3eVA6lC3oGm3z6P5px1356YcDS0BWv7impbzpNpBJXBlzqgpNkz5nlcKNS2y859diJCY93tqzD/pub?output=csv";
  const URL_DENUE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSK87ymKaIGki4st8Fu8NIruKQEuKFR_rrfueefbJ3QFLVAjIGt5E6tBy2v1nhGBh9npPKZp6cRQDc/pub?output=csv";

  const GIROS = {
    "Ferreter√≠as": [467111, 467112, 467113],
    "Automotriz y refacciones": [468211, 468212, 811191, 811192],
    "El√©ctricas e instalaciones": [238221, 467121],
    "Aluminio y metalmec√°nica": [238322, 332322, 332710, 332991],
    "Rotulaci√≥n y construcci√≥n ligera": [323111, 238390],
    "Agr√≠colas y maquinaria": [333111, 333112, 811310, 461110, 461120],
    "Talleres mec√°nicos": [811191, 811192],
    "Refacciones automotrices": [468211, 468212],
    "Alumineros / carp. aluminio": [332322],
    "Instaladores de r√≥tulos": [323111],
    "Suministros industriales": [332991, 332710]
  };

  // Paleta de colores para vendedores (amplia, 20 colores)
  const COLOR_PALETTE = [
    "#FF5733", "#33FF57", "#3357FF", "#F3FF33", "#FF33F3",
    "#33FFF3", "#FF8C33", "#8C33FF", "#33FF8C", "#FF338C",
    "#8CFF33", "#338CFF", "#FF33A8", "#A8FF33", "#33A8FF",
    "#FFD700", "#8A2BE2", "#20B2AA", "#FF69B4", "#7CFC00"
  ];

  /************************ UTILIDADES ************************/
  function normalizarTexto(txt) {
    if (!txt && txt !== 0) return "";
    return String(txt)
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .toLowerCase()
      .trim();
  }

  function valorFila(row, keys) {
    for (const k of keys) {
      if (row[k] !== undefined) return row[k];
    }
    return "";
  }

  function crearIconoEstrella() {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <polygon points="12,2 15,9 22,9 17,14 19,22 12,18 5,22 7,14 2,9 9,9"
        fill="#FFD700" stroke="#E6B800" stroke-width="0.7"/>
    </svg>`;
    return L.divIcon({
      html: `<div 
