<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapa de Vendedores con Leyenda y Contadores</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    #map { height: 100vh; }

    /* Leyenda esquina inferior derecha */
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1000;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      border-radius: 50%;
      border: 1px solid #00000050;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend" id="legend"><strong>Vendedores</strong></div>

<script>
const map = L.map('map').setView([23.2329, -106.4062], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const colorPalette = ["red", "orange", "yellow", "blue", "grey", "black", "gold"];
const vendorColors = {};
let colorIndex = 0;

function createColoredIcon(color) {
  return L.icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}

function getVendorIcon(vendor) {
  const name = vendor.toUpperCase().trim();
  if (name === "WENDY") return createColoredIcon("violet");
  if (name === "ALFREDO") return createColoredIcon("green");
  if (!vendorColors[vendor]) {
    vendorColors[vendor] = colorPalette[colorIndex % colorPalette.length];
    colorIndex++;
  }
  return createColoredIcon(vendorColors[vendor]);
}

function updateLegend(visits) {
  const legendDiv = document.getElementById("legend");
  legendDiv.innerHTML = "<strong>Vendedores</strong>";

  const special = {"WENDY":"violet","ALFREDO":"green"};
  for (const [v, color] of Object.entries(special)) {
    const item = document.createElement("div");
    item.className = "legend-item";
    const colorBox = document.createElement("div");
    colorBox.className = "legend-color";
    colorBox.style.backgroundColor = color;
    item.appendChild(colorBox);
    const count = visits[v] || {hoy:0, mes:0};
    item.appendChild(document.createTextNode(`${v} ${count.hoy}/${count.mes}`));
    legendDiv.appendChild(item);
  }

  for (const [v, color] of Object.entries(vendorColors)) {
    if (v.toUpperCase() === "WENDY" || v.toUpperCase() === "ALFREDO") continue;
    const item = document.createElement("div");
    item.className = "legend-item";
    const colorBox = document.createElement("div");
    colorBox.className = "legend-color";
    colorBox.style.backgroundColor = color;
    item.appendChild(colorBox);
    const count = visits[v] || {hoy:0, mes:0};
    item.appendChild(document.createTextNode(`${v} ${count.hoy}/${count.mes}`));
    legendDiv.appendChild(item);
  }
}

// Parseo robusto de fechas M/D/YYYY H:MM:SS
function parseFechaCSV(fechaStr) {
  if (!fechaStr) return null;
  fechaStr = fechaStr.trim();              // eliminar espacios
  const [fecha, hora] = fechaStr.split(' ');
  if (!fecha) return null;
  const parts = fecha.split('/').map(p => parseInt(p, 10));
  if (parts.length !== 3) return null;
  const [mes, dia, anio] = parts;
  return { dia, mes, anio }; 
}

const hoy = new Date();
const diaHoy = hoy.getDate();
const mesHoy = hoy.getMonth() + 1;
const anioHoy = hoy.getFullYear();

// Cargar CSV
Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vTXTg3eVA6lC3oGm3z6P5px1356YcDS0BWv7impbzpNpBJXBlzqgpNkz5nlcKNS2y859diJCY93tqzD/pub?output=csv", {
  download: true,
  header: true,
  complete: function(results) {
    const visits = {}; // contador por vendedor

    results.data.forEach(row => {
      if (row.COORDENADAS) {
        const coords = row.COORDENADAS.split(',').map(Number);
        if (coords.length === 2) {
          const vendedor = row["NOMBRE VENDEDOR"].trim();
          const icon = getVendorIcon(vendedor);
          L.marker(coords, { icon })
            .addTo(map)
            .bindPopup(
              `<b>Fecha:</b> ${row.FECHA}<br>
               <b>Vendedor:</b> ${vendedor}<br>
               <b>Cliente:</b> ${row["NOMBRE CLIENTE"]}<br>
               <b>Giro:</b> ${row.GIRO}<br>
               <b>Motivo:</b> ${row.MOTIVO}<br>
               <b>Obs:</b> ${row.OBSERVACIONES}`
            );

          if (!visits[vendedor]) visits[vendedor] = {hoy:0, mes:0};

          const fechaCelda = parseFechaCSV(row.FECHA);
          if (!fechaCelda) return;

          // Visitas del d√≠a
          if (fechaCelda.dia === diaHoy && fechaCelda.mes === mesHoy && fechaCelda.anio === anioHoy) visits[vendedor].hoy++;

          // Visitas del mes
          if (fechaCelda.mes === mesHoy && fechaCelda.anio === anioHoy) visits[vendedor].mes++;
        }
      }
    });
    updateLegend(visits);
    console.log("Colores asignados:", vendorColors);
    console.log("Visitas:", visits);
  }
});
</script>
</body>
</html>
