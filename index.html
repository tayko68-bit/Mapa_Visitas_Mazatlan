<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa: Vendedores + Prospectos (DENUE)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin:0; padding:0; }
    #map { height: 100vh; }

    /* Panel superior derecho (plegable) */
    .panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-family: sans-serif;
      z-index: 1000;
      width: 240px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .panel-header {
      padding: 6px 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-content {
      padding: 8px 10px;
    }

    .panel.collapsed {
      max-height: 36px;
    }

    .panel.expanded {
      max-height: 400px;
    }

    .panel select, .panel button {
      width: 14vw;
      max-width: 280px;
      min-width: 200px;
      margin-top:6px;
      padding:6px;
      box-sizing: border-box;
      font-size: 14px;
    }

    /* Leyenda inferior derecha */
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 1000;
      max-height: 40vh;
      overflow-y: auto;
      min-width:150px;
    }
    .legend-item { display:flex; align-items:center; margin-bottom:6px; }
    .legend-color {
      width:16px; height:16px; margin-right:8px; border-radius:50%; border:1px solid #00000040;
      flex:0 0 16px;
    }
    .legend-star {
      width:18px; height:18px; margin-right:8px; display:inline-block; flex:0 0 18px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Panel plegable -->
  <div class="panel" id="panel">
    <div class="panel-header" id="panelToggle">
      üîç Buscar prospectos <span id="arrow">‚ñ∂</span>
    </div>
    <div class="panel-content">
      <label for="giroSelect"><strong>Giro</strong></label>
      <select id="giroSelect">
        <option value="">-- Selecciona un giro --</option>
      </select>
      <button id="buscarBtn">Buscar</button>
      <button id="limpiarBtn">Limpiar</button>
      <div id="status" style="margin-top:6px; font-size:12px; color:#333;"></div>
    </div>
  </div>

  <div class="legend" id="legend"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  /************************ CONFIG ************************/
  const URL_VENDEDORES_CSV = "https://script.google.com/macros/s/AKfycbxxIOHwJwctTDlxwvAX3q6zYmc15q4EZ8gz0CgdLaDvuQs9XbpfAJ4FYjj2M0ZXOjfz/exec";
  const URL_DENUE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSK87ymKaIGki4st8Fu8NIruKQEuKFR_rrfueefbJ3QFLVAjIGt5E6tBy2v1nhGBh9npPKZp6cRQDc/pub?output=csv";

  const GIROS = {
    "Ferreter√≠as": [467111, 467112, 467113],
    "Automotriz y refacciones": [468211, 468212, 811191, 811192],
    "El√©ctricas e instalaciones": [238221, 467121],
    "Aluminio y metalmec√°nica": [238322, 332322, 332710, 332991],
    "Rotulaci√≥n y construcci√≥n ligera": [323111, 238390],
    "Agr√≠colas y maquinaria": [333111, 333112, 811310, 461110, 461120],
    "Talleres mec√°nicos": [811191, 811192],
    "Refacciones automotrices": [468211, 468212],
    "Alumineros / carp. aluminio": [332322],
    "Instaladores de r√≥tulos": [323111],
    "Suministros industriales": [332991, 332710]
  };

  const FIXED_VENDOR_COLORS = {
    "wendy": "violet",
    "alfredo": "green"
  };
    
/************************ AUTO-UPDATE ************************/
let lastVendorHash = null;
let pollingInterval = null;

    
  /************************ UTILIDADES ************************/
  function normalizarTexto(txt) {
    if (!txt && txt !== 0) return "";
    return String(txt)
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .toLowerCase()
      .trim();
  }

  function crearIconoEstrella() {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <polygon points="12,2 15,9 22,9 17,14 19,22 12,18 5,22 7,14 2,9 9,9"
        fill="#FFD700" stroke="#E6B800" stroke-width="0.7"/>
    </svg>`;
    return L.divIcon({
      html: `<div style="width:22px;height:22px;">${svg}</div>`,
      className: '',
      iconSize: [22,22],
      iconAnchor: [11,22],
      popupAnchor: [0,-18]
    });
  }

  function crearIconoColor(colorName) {
    return L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${colorName}.png`,
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }

  /************************ MAPA Y CAPAS ************************/
  const map = L.map('map').setView([23.2329, -106.4062], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const layerVendedores = L.layerGroup().addTo(map);
  const layerProspectos = L.layerGroup().addTo(map);

  let denueData = [];
  let vendedoresData = [];
  let vendorColorMap = {};

  function valorFila(row, keys) {
    for (const k of keys) {
      if (row[k] !== undefined) return row[k];
    }
    return "";
  }

  /************************ CARGA Y RENDER VENDEDORES ************************/
  function renderVendedores(rows) {
    layerVendedores.clearLayers();
    const vendorSet = new Set();
    const vendorList = [];

    // Recolectar todos los vendedores √∫nicos
    rows.forEach(r => {
      const nombreVRaw = valorFila(r, ["NOMBRE VENDEDOR","nombre vendedor","NOMBRE_VENDEDOR","nom_vendedor"]) || "Sin vendedor";
      const nombreV = normalizarTexto(nombreVRaw);
      vendorSet.add(nombreV);
    });

    // Ordenar alfab√©ticamente
    vendorList.push(...Array.from(vendorSet).sort());

    // Asignar colores
    const palette = ["red","orange","yellow","blue","grey","black","green","violet","pink","cadetblue"];
    let colorIndex = 0;
    vendorColorMap = {};

    vendorList.forEach(nombreV => {
      if (FIXED_VENDOR_COLORS[nombreV]) {
        vendorColorMap[nombreV] = FIXED_VENDOR_COLORS[nombreV];
      } else {
        let color = palette[colorIndex % palette.length];
        // Evitar colores duplicados si hay m√°s vendedores que colores
        while (Object.values(vendorColorMap).includes(color) && colorIndex < palette.length * 2) {
          colorIndex++;
          color = palette[colorIndex % palette.length];
        }
        vendorColorMap[nombreV] = color;
        colorIndex++;
      }
    });

    // Renderizar marcadores
    rows.forEach(r => {
      const nombreVRaw = valorFila(r, ["NOMBRE VENDEDOR","nombre vendedor","NOMBRE_VENDEDOR","nom_vendedor"]) || "Sin vendedor";
      const nombreV = normalizarTexto(nombreVRaw);
      const coordStr = valorFila(r, ["COORDENADAS","coordenadas","Coordenadas"]) || "";
      let lat=null, lon=null;
      if(coordStr.includes(",")){
        const p = coordStr.split(",").map(s=>s.trim());
        lat=parseFloat(p[0]); lon=parseFloat(p[1]);
      } else {
        lat=parseFloat(valorFila(r, ["latitud","LATITUD","Latitud"]));
        lon=parseFloat(valorFila(r, ["longitud","LONGITUD","Longitud"]));
      }
      if(isNaN(lat)||isNaN(lon)) return;

      const colorName = vendorColorMap[nombreV];

      const marker = L.marker([lat, lon], { icon: crearIconoColor(colorName) });
      const cliente = valorFila(r, ["NOMBRE CLIENTE","NOMBRE_CLIENTE","nombre cliente","nom_estab"]) || "";
      const fecha = valorFila(r, ["FECHA","fecha"]) || "";
      const giro = valorFila(r, ["GIRO","giro"]) || "";
      const motivo = valorFila(r, ["MOTIVO","motivo"]) || "";
      const obs = valorFila(r, ["OBSERVACIONES","observaciones"]) || "";

      marker.bindPopup(
        `<b>Vendedor:</b> ${nombreVRaw}<br>
        <b>Fecha:</b> ${fecha}<br>
        <b>Cliente:</b> ${cliente}<br>
        <b>Giro:</b> ${giro}<br>
        <b>Motivo:</b> ${motivo}<br>
        <b>Obs:</b> ${obs}`
      );
      marker.addTo(layerVendedores);
    });

    actualizarLeyenda();
  }

  function cargarVendedores() {
  const status = document.getElementById('status');
  status.textContent = "Cargando vendedores...";

  // üîΩ Evitar cach√© del CSV
  const urlConCacheBuster = URL_VENDEDORES_CSV + "&_=" + new Date().getTime();

  Papa.parse(urlConCacheBuster, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete(results){
      vendedoresData = results.data;
      renderVendedores(vendedoresData);
      actualizarLeyenda();
      status.textContent = `Vendedores cargados: ${vendedoresData.length}`;
      setTimeout(() => { status.textContent = ""; }, 3000);
      console.log("Vendedores cargados:", vendedoresData.length);
    },
    error(err){ 
      console.error(err); 
      status.textContent = "Error cargando vendedores";
    }
  });
}

  /************************ CARGA DENUE ************************/
  function cargarDENUE(){
    document.getElementById('status').textContent = "Cargando base DENUE...";
    Papa.parse(URL_DENUE_CSV, {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete(results){
        denueData = results.data.map(r=>{
          return {
            nom_estab: r.nom_estab || r.NOMBRE_ESTAB || "",
            raz_social: r.raz_social || "",
            codigo_act: r.codigo_act || "",
            nombre_act: r.nombre_act || "",
            latitud: parseFloat(r.latitud),
            longitud: parseFloat(r.longitud),
            telefono: r.telefono || "",
            direccion: `${r.tipo_vial||""} ${r.nom_vial||""} ${r.numero_ext||""} ${r.letra_ext||""}`.trim()
          };
        }).filter(d=>!isNaN(d.latitud)&&!isNaN(d.longitud));
        document.getElementById('status').textContent = `DENUE cargada: ${denueData.length} registros`;
      },
      error(err){ console.error(err); document.getElementById('status').textContent="Error cargando DENUE"; }
    });
  }

  /************************ LLENAR GIROS ************************/
  const giroSelect = document.getElementById('giroSelect');
  Object.keys(GIROS).forEach(nombre=>{
    const opt = document.createElement('option');
    opt.value=nombre; opt.textContent=nombre;
    giroSelect.appendChild(opt);
  });

  /************************ BUSCAR PROSPECTOS ************************/
  function buscarProspectos(){
    layerProspectos.clearLayers();
    const giroNombre = giroSelect.value;
    if(!giroNombre){
      document.getElementById('status').textContent = "Selecciona un giro primero";
      return;
    }
    const codigos = GIROS[giroNombre].map(c=>String(c));

    const resultados = denueData.filter(d=>{
      const code = String(d.codigo_act||"").replace(/\D/g,'');
      return codigos.includes(code);
    });

    const iconEstrella = crearIconoEstrella();
    resultados.forEach(r=>{
      const mk = L.marker([r.latitud, r.longitud],{icon: iconEstrella})
        .bindPopup(
          `<b>${r.nom_estab||'Sin nombre'}</b><br>
           <b>Raz√≥n social:</b> ${r.raz_social||''}<br>
           <b>Direcci√≥n:</b> ${r.direccion||''}<br>
           <b>Tel√©fono:</b> ${r.telefono||''}<br>
           <b>SCIAN:</b> ${r.codigo_act||''}`
        );
      mk.addTo(layerProspectos);
    });

    document.getElementById('status').textContent = `${resultados.length} prospectos encontrados`;
    actualizarLeyenda();
  }

  function limpiarProspectos(){
    layerProspectos.clearLayers();
    document.getElementById('status').textContent="Prospectos limpiados";
    actualizarLeyenda();
  }

  /************************ LEYENDA ************************/

    function actualizarLeyenda() {
  const legend = document.getElementById('legend');
  legend.innerHTML = "";

  // üî¥ Validar que los datos de vendedores est√©n cargados
  if (!vendedoresData || vendedoresData.length === 0) {
    legend.innerHTML = "<div class='legend-item' style='color:#999;'>Cargando vendedores...</div>";
    return;
  }

  // üîΩ Calcular contador para cada vendedor
  const contadores = {};

  vendedoresData.forEach(r => {
    const nombreVRaw = valorFila(r, ["NOMBRE VENDEDOR","nombre vendedor","NOMBRE_VENDEDOR","nom_vendedor"]) || "Sin vendedor";
    const nombreV = normalizarTexto(nombreVRaw);

    // Inicializar contador si no existe
    if (!contadores[nombreV]) {
      contadores[nombreV] = { hoy: 0, mes: 0 };
    }

    const fechaRaw = valorFila(r, ["FECHA","fecha"]) || "";
    let fecha = null;

    // üîΩ Parsear formato espec√≠fico: "6/9/2025 10:22:37" ‚Üí d/m/Y H:i:s
    const match = fechaRaw.trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})$/);
    if (match) {
      const [, dia, mes, anio, hora, min, seg] = match;
      fecha = new Date(anio, mes - 1, dia, hora, min, seg); // mes es 0-indexado
    } else {
      // Fallback para otros formatos (como YYYY-MM-DD)
      fecha = new Date(fechaRaw.trim());
    }

    // üîΩ Validar fecha v√°lida
    if (isNaN(fecha.getTime())) {
      return; // ignorar registros con fecha inv√°lida
    }

    // üîΩ Normalizar para comparaci√≥n: hoy y mes actual
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0); // inicio del d√≠a

    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1, 0, 0, 0);
    const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0, 23, 59, 59); // √∫ltimo d√≠a del mes

    // Comparar solo la parte del d√≠a para "hoy"
    const fechaInicioDia = new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate(), 0, 0, 0);
    const esHoy = fechaInicioDia.getTime() === hoy.getTime();

    // Contar solo si est√° en el mes actual
    if (fecha >= inicioMes && fecha <= finMes) {
      contadores[nombreV].mes++;
      if (esHoy) {
        contadores[nombreV].hoy++;
      }
    }
  });

  // üîΩ Ordenar vendedores alfab√©ticamente
  const sortedVendors = Object.keys(vendorColorMap).sort();

  sortedVendors.forEach(nombreV => {
    // Buscar el nombre original (no normalizado) para mostrar en leyenda
    let nombreOriginal = nombreV.charAt(0).toUpperCase() + nombreV.slice(1);
    for (const r of vendedoresData) {
      const raw = valorFila(r, ["NOMBRE VENDEDOR","nombre vendedor","NOMBRE_VENDEDOR","nom_vendedor"]) || "";
      if (normalizarTexto(raw) === nombreV) {
        nombreOriginal = raw;
        break;
      }
    }

    // üîΩ Obtener contadores
    const contador = contadores[nombreV] || { hoy: 0, mes: 0 };
    const textoContador = ` üìÖ${contador.hoy} üìä${contador.mes}`;

    // üîΩ Crear elemento de leyenda
    const div = document.createElement('div');
    div.className = 'legend-item';

    const box = document.createElement('div');
    box.className = 'legend-color';
    box.style.backgroundColor = vendorColorMap[nombreV];
    div.appendChild(box);

    // A√±adir nombre + contador
    const textNode = document.createTextNode(` ${nombreOriginal}${textoContador}`);
    div.appendChild(textNode);

    legend.appendChild(div);
  });

  // üîΩ A√±adir entrada de "Prospectos (DENUE)"
  const p = document.createElement('div');
  p.className = 'legend-item';

  const star = document.createElement('div');
  star.className = 'legend-star';
  star.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <polygon points="12,2 15,9 22,9 17,14 19,22 12,18 5,22 7,14 2,9 9,9"
        fill="#FFD700" stroke="#E6B800" stroke-width="0.7"/>
    </svg>
  `;
  p.appendChild(star);

  p.appendChild(document.createTextNode(" Prospectos (DENUE)"));
  legend.appendChild(p);
}


/************************ AUTO-UPDATE (ROBUSTO con Papa.parse) ************************/
function verificarActualizaciones() {
  if (pollingInterval) {
    clearInterval(pollingInterval);
  }

  pollingInterval = setInterval(() => {
    const timestamp = new Date().getTime();
    const urlConCacheBuster = URL_VENDEDORES_CSV + "&_=" + timestamp;
const timestamp = new Date().getTime();
const urlConCacheBuster = `${URL_VENDEDORES_CSV}?t=${timestamp}`;
    console.log("üîç Verificando cambios en vendedores...", new Date().toLocaleTimeString());

 Papa.parse(urlConCacheBuster, {
  download: true,
  header: false,
  skipEmptyLines: true,
  fastMode: true,
  // üîΩ A√±ade esto: transformRequest
  transformRequest: (url) => {
    return {
      url: url,
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    };
  },
  complete: function(results) {
    if (!results.data || results.data.length === 0) return;

    const lineas = results.data.map(row => Object.values(row).join(",")).filter(line => line.trim() !== "");

    if (lineas.length === 0) return;

    // üîΩ Hash robusto: basado en contenido total (detecta ediciones, sin btoa)
    const contenidoTotal = lineas.join("|||");
    const nuevoHash = lineas.length + "|" + crearHash(contenidoTotal);

    if (lastVendorHash && lastVendorHash !== nuevoHash) {
      console.log("üìä Cambio detectado en CSV:", {
        old: lastVendorHash,
        new: nuevoHash
      });

      const status = document.getElementById('status');
      status.textContent = "üîÑ Cambio detectado. Actualizando vendedores...";
      setTimeout(() => { status.textContent = ""; }, 3000);

      mostrarNotificacion("üîÑ Vendedores actualizados autom√°ticamente");

      cargarVendedores();
    }

    lastVendorHash = nuevoHash;
  },
  error: function(err) {
    console.warn("‚ö†Ô∏è Fallo al verificar actualizaci√≥n (se reintentar√° en 30s):", err.message);
  }
});
  }, 30000);
}

// üîΩ Funci√≥n para crear hash seguro (reemplaza btoa)
function crearHash(texto) {
  const encoder = new TextEncoder();
  const data = encoder.encode(texto);
  let hash = 0;
  for (let i = 0; i < data.length; i++) {
    hash = ((hash << 5) - hash) + data[i];
    hash = hash & hash; // Convertir a 32-bit integer
  }
  return hash.toString(36); // Base36 (corto y legible)
}

// üîΩ Funci√≥n de notificaci√≥n visual (opcional)
function mostrarNotificacion(mensaje) {
  const toast = document.createElement('div');
  toast.textContent = mensaje;
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.right = '20px';
  toast.style.background = '#28a745';
  toast.style.color = 'white';
  toast.style.padding = '10px 15px';
  toast.style.borderRadius = '6px';
  toast.style.zIndex = '2000';
  toast.style.fontSize = '14px';
  toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// üîΩ Reactivar polling si la pesta√±a se reactiva (evita que el navegador lo "duerma")
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && pollingInterval) {
    console.log("üîÑ Pesta√±a reactivada. Reiniciando polling...");
    clearInterval(pollingInterval);
    verificarActualizaciones();
  }
});

  /************************ EVENTOS ************************/
  document.getElementById('buscarBtn').addEventListener('click', buscarProspectos);
  document.getElementById('limpiarBtn').addEventListener('click', limpiarProspectos);

  // Toggle panel plegable
  const panel = document.getElementById('panel');
  const toggle = document.getElementById('panelToggle');
  const arrow = document.getElementById('arrow');
  panel.classList.add('collapsed');
  toggle.addEventListener('click', () => {
    if (panel.classList.contains('collapsed')) {
      panel.classList.remove('collapsed');
      panel.classList.add('expanded');
      arrow.textContent = "‚ñº";
    } else {
      panel.classList.remove('expanded');
      panel.classList.add('collapsed');
      arrow.textContent = "‚ñ∂";
    }
  });

  /************************ INICIO ************************/
cargarVendedores();
cargarDENUE();

// üîΩ Iniciar verificaci√≥n autom√°tica cada 30 segundos
verificarActualizaciones();
  </script>
</body>
</html>
